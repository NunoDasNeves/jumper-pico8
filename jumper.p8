pico-8 cartridge // http://www.pico-8.com
version 33
__lua__
-- whacker

#include util.lua

-- 
dbg = false

-- player
p = {}
p.x = 64
p.y = 64
p.faceright = true
p.vx = 0
p.vy = 0
p.air = true
p.frame = 0
p.fcount = 0
p.s = 64
-- constants
p.spr = 64
p.footwidth = 4
p.w = 8
p.h = 8
p.ax = 1
p.max_vx = 3
p.min_vx = 0.01
p.g = 0.5
p.max_vy = 5
p.j_vy = -6

-- disable btnp repeating
poke(0x5f5c, 255)

function collplat(x,y)
 local mx = x/8
 local my = y/8
 local val = mget(mx,my)

 if (fget(val,2)) then
  return true
 end
 	return false
end

function collwall(x,y)
 local mx = x/8
 local my = y/8
 local val = mget(mx,my)

 if (fget(val,1)) then
  return true
 end
 	return false
end

function p_update()
 -- change direction
 if (btnp(‚¨ÖÔ∏è) or
     btn(‚¨ÖÔ∏è) and not btn(‚û°Ô∏è)) then
  p.faceright = false
 elseif (btnp(‚û°Ô∏è) or
     btn(‚û°Ô∏è) and not btn(‚¨ÖÔ∏è)) then
  p.faceright = true
 end
 if (btn(‚¨ÖÔ∏è) and not p.faceright) then
 	-- accel left
 	p.vx -= p.ax
 elseif (btn(‚û°Ô∏è) and p.faceright) then
 	-- accel right
 	p.vx += p.ax
 end
 if (not btn(‚¨ÖÔ∏è) and not btn(‚û°Ô∏è)) then
  p.vx -= p.vx/3
 end
 p.vx = clamp(p.vx, -p.max_vx, p.max_vx)
 if (abs(p.vx) < p.min_vx) then
  p.vx = 0
 end

 local newx = p.x + p.vx
 if (collwall(newx,p.y)) then
  p.vx = -p.vx
  newx = p.x + p.vx
 end
 p.x = newx

 -- vy - jump and land
	if (btn(üÖæÔ∏è) and not p.air) then
		 p.vy += p.j_vy
		 p.air = true
	end
	p.vy += p.g
	p.vy = clamp(p.vy, -p.max_vy, p.max_vy)

 local newy = p.y + p.vy

 if (p.vy > 0) then
  if (collplat(p.x,newy) and
      -- need both checks!
      (not p.air or
      rounddown(p.y,8) < rounddown(newy,8))) then
			newy = rounddown(newy, 8)
	  p.vy = 0
	  p.air = false
	 else
	  p.air = true
	 end
 end
 p.y = newy
 
 if (p.y > 128) then
  -- todo: dead
 end

 p.fcount += 1 
 if (not p.air) then
  if (btn(‚û°Ô∏è) or btn(‚¨ÖÔ∏è)) then
  	if (p.fcount > 2) then
	 		p.frame = (p.frame + 1) % 2
	 		p.fcount = 0
	 	end
	 else
	  p.frame = 0
	 end
 else
 	p.frame = 0
 end

end

function _update()
	p_update()
end

function _draw()
	cls(0)
	map(0,0,0,0,128,64)
	spr(p.s + p.frame,
	    flr(p.x-p.w/2),
	    flr(p.y-p.h),
	    1, 1,
	    not p.faceright)
	if (dbg) then
		print(p.x..' '..p.y,8,0,7)
		print(mget(p.x/8,p.y/8),8,8,7)
		print(collplat(p.x,p.y),8,16,7)
	--print(collwall(p.x,p.y),10,30,7)
	end
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44144441000000005544444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000
11111441000000000555555005555555554445545555555000000000000000000000000000000000000000000000000000000000000000000000000000000000
41444114000000000055550000055555555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000
41441114000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11114411000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44144441000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44414414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00033300000333000003330000d0d300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00331130003311300033333000333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00311130003111300033311300333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03311130033111300333113303333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03333330033333300333133003333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0333333003333330033333d003333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333003333330000333d0000333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00d00d000005d00000030d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000002000404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000001314141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1014150000000000000000001200001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000001314141500000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000120000000000131414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000001200000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000012001200001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1013141414150000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000001314141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000013150000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1014141414141414141414141414141000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
